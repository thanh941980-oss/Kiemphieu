<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ki·ªÉm phi·∫øu - Qu·∫£n l√Ω Phi·∫øu b·∫ßu</title>

<style>
/* --- Giao di·ªán th·ªëng nh·∫•t v·ªõi tonghop.html --- */
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
body { background-color: #f5f7fa; color: #333; font-size: 14px; line-height: 1.4; }
.container { display: flex; min-height: 100vh; }

/* Sidebar c·ªë ƒë·ªãnh b√™n tr√°i */
.sidebar { width: 220px; background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; padding: 15px 0; box-shadow: 2px 0 10px rgba(0,0,0,0.1); flex-shrink: 0; }
.logo { text-align: center; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 15px; }
.logo h1 { font-size: 18px; font-weight: 600; }
.nav-links { list-style: none; padding: 0 10px; }
.nav-links li { margin-bottom: 8px; }
.nav-links a { display: flex; align-items: center; padding: 10px 12px; color: white; text-decoration: none; border-radius: 6px; transition: all 0.3s ease; font-size: 14px; }
.nav-links a:hover, .nav-links a.active { background-color: rgba(255,255,255,0.1); }
.nav-links i { margin-right: 8px; font-size: 16px; }
.logout { margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; }

/* Main content */
.main-content { flex: 1; padding: 20px; min-width: 0; }
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
.header h2 { font-size: 20px; color: #2a5298; }
.user-info { display: flex; align-items: center; background: white; padding: 8px 16px; border-radius: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); font-size: 13px; }
.user-info img { width: 32px; height: 32px; border-radius: 50%; margin-right: 8px; }
.header-controls { display: flex; align-items: center; gap: 10px; }
.btn { padding: 8px 16px; background: #2a5298; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: background 0.3s ease; }
.btn:hover { background: #1e3c72; }
.btn-success { background: #28a745; }
.btn-success:hover { background: #218838; }

/* Section */
.section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
.section h3 { font-size: 16px; color: #2a5298; margin-bottom: 15px; font-weight: 600; }

/* Tables */
.table-wrapper { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 600px; }
th, td { border: 1px solid #e0e0e0; padding: 10px; text-align: center; }
th { background-color: #2a5298; color: white; font-weight: 600; }
.highlight { background: #e8f5e8; font-weight: 600; }

/* Responsive */
@media (max-width: 768px) {
  body { font-size: 13px; }
  .main-content { padding: 15px; }
  th, td { padding: 8px; }
  .btn { padding: 6px 12px; font-size: 12px; }
  .user-info span { display: none; }
  .user-info img { margin-right: 0; }
  table { font-size: 12px; min-width: 500px; }
}
</style>
</head>

<body>
<div class="container">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="logo"><h1>H·ªÜ TH·ªêNG B·∫¶U C·ª¨</h1></div>
    <ul class="nav-links">
      <li><a href="thongtin.html"><i>‚ÑπÔ∏è</i> Th√¥ng tin</a></li>
      <li><a href="#" class="active"><i>‚úÖ</i> Ki·ªÉm phi·∫øu</a></li>
      <li><a href="tonghop.html"><i>üìà</i> T·ªïng h·ª£p</a></li>
      <li><a href="bienban.html"><i>üìù</i> Bi√™n b·∫£n</a></li>
      <li class="logout"><a href="#" id="logout"><i>üö™</i> ƒêƒÉng xu·∫•t</a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="header">
      <h2>Ki·ªÉm phi·∫øu - Qu·∫£n l√Ω Phi·∫øu b·∫ßu</h2>
      <div class="header-controls">
        <div class="user-info">
          <img src="https://ui-avatars.com/api/?name=Admin&background=2a5298&color=fff" />
          <span id="userName">Qu·∫£n tr·ªã vi√™n</span>
        </div>
        <button class="btn btn-success" onclick="saveKiemPhieu()">üíæ L∆∞u</button>
        <button class="btn" onclick="loadKiemPhieu()">üîÑ T·∫£i l·∫°i</button>
      </div>
    </div>

    <!-- Th√¥ng tin chung -->
    <div class="section">
      <h3>TH√îNG TIN CHUNG</h3>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
        <div>
          <label>T·ªïng s·ªë c·ª≠ tri:</label>
          <input type="number" id="tongSoCuTri" class="form-control" style="width:100%;padding:6px;" />
        </div>
        <div>
          <label>S·ªë tham gia b·ªè phi·∫øu:</label>
          <input type="number" id="thamGiaBoPhieu" class="form-control" style="width:100%;padding:6px;" />
        </div>
        <div>
          <label>S·ªë phi·∫øu ph√°t ra:</label>
          <input type="number" id="soPhieuPhatRa" class="form-control" style="width:100%;padding:6px;" />
        </div>
        <div>
          <label>S·ªë phi·∫øu thu v√†o:</label>
          <span id="soPhieuThuVao" style="font-weight:bold;color:#2a5298;">0</span>
        </div>
      </div>
    </div>

    <!-- Danh s√°ch ·ª©ng c·ª≠ vi√™n -->
    <div class="section">
      <h3>K·∫æT QU·∫¢ ·ª®NG C·ª¨ VI√äN</h3>
      <div class="table-wrapper">
        <table id="candidateTable">
          <thead>
            <tr>
              <th>STT</th>
              <th>H·ªç v√† t√™n</th>
              <th>S·ªë phi·∫øu</th>
              <th>T·ª∑ l·ªá (%)</th>
            </tr>
          </thead>
          <tbody id="candidateBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Ki·ªÉm tra t·ª´ng phi·∫øu -->
    <div class="section">
      <h3>KI·ªÇM TRA T·ª™NG PHI·∫æU</h3>
      <div class="table-wrapper">
        <table id="phieuTable">
          <thead>
            <tr>
              <th>S·ªë phi·∫øu</th>
              <th>N·ªôi dung</th>
              <th>Thao t√°c</th>
            </tr>
          </thead>
          <tbody id="phieuBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

<script>
// C·∫•u h√¨nh Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAt-OooTscmthbJXNcvy80RgPDA9T46-0w",
  authDomain: "kiemphieu-45823.firebaseapp.com",
  databaseURL: "https://kiemphieu-45823-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "kiemphieu-45823",
  storageBucket: "kiemphieu-45823.firebasestorage.app",
  messagingSenderId: "908329514571",
  appId: "1:908329514571:web:16b43df5b795e4de06bfce"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

let currentUser = null;
let candidates = [];
let phieuDetails = [];

// X·ª≠ l√Ω t·∫£i d·ªØ li·ªáu ki·ªÉm phi·∫øu
async function loadKiemPhieu() {
  try {
    const user = auth.currentUser;
    if (!user) return alert("Ch∆∞a ƒëƒÉng nh·∫≠p!");
    const base = `users/${user.uid}`;

    const dataSnap = await db.ref(`${base}/kiemPhieuData`).once('value');
    const resultSnap = await db.ref(`${base}/candidateResults`).once('value');
    const phieuSnap = await db.ref(`${base}/phieuDetails`).once('value');

    if (dataSnap.exists()) {
      const d = dataSnap.val();
      document.getElementById('tongSoCuTri').value = d.tongSoCuTri || 0;
      document.getElementById('thamGiaBoPhieu').value = d.thamGiaBoPhieu || 0;
      document.getElementById('soPhieuPhatRa').value = d.soPhieuPhatRa || 0;
      document.getElementById('soPhieuThuVao').textContent = d.soPhieuThuVao || 0;
    }

    candidates = [];
    if (resultSnap.exists()) {
      const r = resultSnap.val();
      Object.keys(r).forEach((id, i) => {
        candidates.push({
          stt: i + 1,
          name: r[id].name,
          votes: r[id].votes || 0,
          percent: 0
        });
      });
    }

    // Hi·ªÉn th·ªã b·∫£ng ·ª©ng c·ª≠ vi√™n
    const total = candidates.reduce((sum, c) => sum + c.votes, 0);
    const tbody = document.getElementById('candidateBody');
    tbody.innerHTML = "";
    candidates.forEach(c => {
      const p = total ? ((c.votes / total) * 100).toFixed(1) : 0;
      const row = `<tr><td>${c.stt}</td><td>${c.name}</td><td>${c.votes}</td><td>${p}%</td></tr>`;
      tbody.insertAdjacentHTML('beforeend', row);
    });

    // D·ªØ li·ªáu phi·∫øu
    if (phieuSnap.exists()) {
      const data = phieuSnap.val();
      phieuDetails = Array.isArray(data) ? data.filter(p => p) : Object.values(data);
      const body = document.getElementById('phieuBody');
      body.innerHTML = "";
      phieuDetails.forEach(p => {
        body.insertAdjacentHTML('beforeend', `<tr><td>${p.phieuSo}</td><td>${JSON.stringify(p.selectedIds || [])}</td><td><button class="btn btn-success">Xem</button></td></tr>`);
      });
    }
  } catch (e) {
    console.error(e);
    alert("L·ªói khi t·∫£i d·ªØ li·ªáu ki·ªÉm phi·∫øu!");
  }
}

// L∆∞u d·ªØ li·ªáu
async function saveKiemPhieu() {
  try {
    const user = auth.currentUser;
    if (!user) return alert("Ch∆∞a ƒëƒÉng nh·∫≠p!");
    const base = `users/${user.uid}`;
    const data = {
      tongSoCuTri: parseInt(document.getElementById('tongSoCuTri').value) || 0,
      thamGiaBoPhieu: parseInt(document.getElementById('thamGiaBoPhieu').value) || 0,
      soPhieuPhatRa: parseInt(document.getElementById('soPhieuPhatRa').value) || 0,
      soPhieuThuVao: parseInt(document.getElementById('soPhieuThuVao').textContent) || 0
    };
    await db.ref(`${base}/kiemPhieuData`).set(data);
    alert("ƒê√£ l∆∞u d·ªØ li·ªáu th√†nh c√¥ng!");
  } catch (e) {
    console.error(e);
    alert("L·ªói khi l∆∞u ki·ªÉm phi·∫øu!");
  }
}

auth.onAuthStateChanged(user => {
  if (user) {
    currentUser = user;
    document.getElementById('userName').textContent = user.email || "Qu·∫£n tr·ªã vi√™n";
    loadKiemPhieu();
  } else {
    window.location.href = "index.html";
  }
});

document.getElementById('logout').addEventListener('click', e => {
  e.preventDefault();
  if (confirm('ƒêƒÉng xu·∫•t kh·ªèi h·ªá th·ªëng?')) auth.signOut();
});
</script>
</body>
</html>
