<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>T·ªïng h·ª£p - Qu·∫£n l√Ω Phi·∫øu b·∫ßu</title>
<style>
/* --- Gi·ªØ nguy√™n ph·∫ßn CSS g·ªëc c·ªßa b·∫°n --- */
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
body { background-color: #f5f7fa; color: #333; font-size: 13px; line-height: 1.4; }
.container { display: flex; min-height: 100vh; }
.sidebar { width: 220px; background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; padding: 15px 0; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
.logo { text-align: center; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 15px; }
.logo h1 { font-size: 18px; font-weight: 600; }
.nav-links { list-style: none; padding: 0 10px; }
.nav-links li { margin-bottom: 8px; }
.nav-links a { display: flex; align-items: center; padding: 10px 12px; color: white; text-decoration: none; border-radius: 6px; transition: all 0.3s ease; font-size: 13px; }
.nav-links a:hover, .nav-links a.active { background-color: rgba(255,255,255,0.1); }
.nav-links i { margin-right: 8px; font-size: 16px; }
.logout { margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; }
.main-content { flex: 1; padding: 20px; min-width: 0; }
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
.header h2 { font-size: 20px; color: #2a5298; }
.user-info { display: flex; align-items: center; background: white; padding: 8px 16px; border-radius: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); font-size: 13px; }
.user-info img { width: 32px; height: 32px; border-radius: 50%; margin-right: 8px; }
.header-controls { display: flex; align-items: center; gap: 10px; }
.btn { padding: 8px 16px; background: #2a5298; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: background 0.3s ease; }
.btn:hover { background: #1e3c72; }
.btn-success { background: #28a745; }
.btn-success:hover { background: #218838; }
.summary-section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
.summary-section h3 { font-size: 16px; color: #2a5298; margin-bottom: 15px; font-weight: 600; }
.summary-table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 13px; }
.summary-table th, .summary-table td { padding: 12px 15px; text-align: center; border: 1px solid #e0e0e0; }
.summary-table th { background-color: #2a5298; color: white; font-weight: 600; font-size: 13px; }
.summary-table td { background-color: #fff; }
.summary-table .header-row { background-color: #1e3c72; color: white; font-weight: bold; }
.summary-table .sub-header { background-color: #f8f9fa; font-weight: 600; color: #2a5298; }
.candidate-name { text-align: left; font-weight: 600; }
.highlight { background-color: #e8f5e8 !important; font-weight: 600; }
.loading { text-align: center; padding: 20px; color: #666; font-size: 13px; }
.status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; }
.status-online { background-color: #28a745; }
.status-offline { background-color: #dc3545; }
</style>
</head>

<body>
<div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <h1>H·ªÜ TH·ªêNG B·∫¶U C·ª¨</h1>
        </div>
        <ul class="nav-links">
            <li><a href="thongtin.html"><i>‚ÑπÔ∏è</i> Th√¥ng tin</a></li>
            <li><a href="kiemphieu.html"><i>‚úÖ</i> Ki·ªÉm phi·∫øu</a></li>
            <li><a href="#" class="active" data-target="tonghop"><i>üìà</i> T·ªïng h·ª£p</a></li>
            <li><a href="#" data-target="bienban"><i>üìù</i> Bi√™n b·∫£n</a></li>
            <li class="logout"><a href="#" id="logout"><i>üö™</i> ƒêƒÉng xu·∫•t</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <h2>T·ªïng h·ª£p k·∫øt qu·∫£ b·∫ßu c·ª≠</h2>
            <div class="header-controls">
                <div class="user-info">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=2a5298&color=fff" alt="User">
                    <span id="userName">Qu·∫£n tr·ªã vi√™n</span>
                </div>
                <button onclick="refreshData()" class="btn btn-success">üîÑ L√†m m·ªõi</button>
            </div>
        </div>

        <div id="loading" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>

        <div id="mainContent" style="display:none;">
            <!-- Tr·∫°ng th√°i -->
            <div class="summary-section">
                <h3>TR·∫†NG TH√ÅI D·ªÆ LI·ªÜU</h3>
                <div id="connectionStatus">
                    <span class="status-indicator status-offline"></span>
                    <span>ƒêang k·∫øt n·ªëi...</span>
                </div>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:15px;">
                    <div style="background:#f8f9fa;padding:15px;border-radius:6px;border-left:4px solid #2a5298;">
                        <div style="font-size:12px;color:#666;">T·ªïng s·ªë phi·∫øu</div>
                        <div style="font-size:18px;font-weight:bold;color:#2a5298;" id="totalVotesDisplay">0</div>
                    </div>
                    <div style="background:#f8f9fa;padding:15px;border-radius:6px;border-left:4px solid #28a745;">
                        <div style="font-size:12px;color:#666;">S·ªë ·ª©ng c·ª≠ vi√™n</div>
                        <div style="font-size:18px;font-weight:bold;color:#28a745;" id="totalCandidatesDisplay">0</div>
                    </div>
                    <div style="background:#f8f9fa;padding:15px;border-radius:6px;border-left:4px solid #ffc107;">
                        <div style="font-size:12px;color:#666;">C·∫≠p nh·∫≠t l·∫ßn cu·ªëi</div>
                        <div style="font-size:12px;font-weight:bold;color:#ffc107;" id="lastUpdateDisplay">--:--:--</div>
                    </div>
                </div>
            </div>

            <!-- B·∫£ng 1 -->
            <div class="summary-section">
                <h3>S·ªê PHI·∫æU B·∫¶U CHO T·ª™NG NG∆Ø·ªúI</h3>
                <table class="summary-table">
                    <thead>
                        <tr class="header-row">
                            <th rowspan="2">S·ªë phi·∫øu b·∫ßu cho</th>
                            <th colspan="0" id="candidateCountHeader">S·ªë l∆∞·ª£ng ng∆∞·ªùi ƒë∆∞·ª£c b·∫ßu</th>
                        </tr>
                        <tr class="sub-header" id="candidateHeaders"></tr>
                    </thead>
                    <tbody id="votesDistributionBody"></tbody>
                </table>
            </div>

            <!-- B·∫£ng 2 -->
            <div class="summary-section">
                <h3>K·∫æT QU·∫¢ B·∫¶U C·ª¨</h3>
                <table class="summary-table" id="electionResultsTable">
                    <thead>
                        <tr class="header-row">
                            <th>STT</th>
                            <th>H·ªç v√† t√™n ·ª©ng c·ª≠ vi√™n</th>
                            <th>S·ªë phi·∫øu ƒë∆∞·ª£c b·∫ßu</th>
                            <th>T·ª∑ l·ªá %</th>
                            <th>X·∫øp h·∫°ng</th>
                        </tr>
                    </thead>
                    <tbody id="electionResultsBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script>
const firebaseConfig = {
    apiKey: "AIzaSyAt-OooTscmthbJXNcvy80RgPDA9T46-0w",
    authDomain: "kiemphieu-45823.firebaseapp.com",
    databaseURL: "https://kiemphieu-45823-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "kiemphieu-45823",
    storageBucket: "kiemphieu-45823.firebasestorage.app",
    messagingSenderId: "908329514571",
    appId: "1:908329514571:web:16b43df5b795e4de06bfce"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();
let currentUser=null,realtimeListeners=[];

function getUserPath(p=''){ if(!currentUser||!currentUser.uid) throw new Error('User not authenticated'); return `users/${currentUser.uid}${p?'/'+p:''}`;}
function calculatePercent(v,t){return t===0?0:((v/t)*100).toFixed(1);}
function updateConnectionStatus(connected){const el=document.getElementById('connectionStatus');const ind=el.querySelector('.status-indicator');const txt=el.querySelector('span:last-child');if(connected){ind.className='status-indicator status-online';txt.textContent='ƒêang k·∫øt n·ªëi real-time';}else{ind.className='status-indicator status-offline';txt.textContent='M·∫•t k·∫øt n·ªëi';}}

function updateLastUpdateTime(){document.getElementById('lastUpdateDisplay').textContent=new Date().toLocaleTimeString('vi-VN');}

// -----------------------
// T√çNH PH√ÇN B·ªê PHI·∫æU
// -----------------------
function calculateRealDistribution(phieuDetails,totalCandidates){
 const d={};if(!phieuDetails||phieuDetails.length===0){for(let i=1;i<=totalCandidates;i++)d[i]=0;return d;}
 phieuDetails.forEach(p=>{if(p&&p.selectedIds){const soDuocBau=totalCandidates-p.selectedIds.length;if(soDuocBau>=1&&soDuocBau<=totalCandidates)d[soDuocBau]=(d[soDuocBau]||0)+1;}});
 for(let i=1;i<=totalCandidates;i++)if(d[i]===undefined)d[i]=0;
 return d;
}

function updateVotesDistributionTable(phieuDetails,totalVotes,totalCandidates){
 const body=document.getElementById('votesDistributionBody'),hdr=document.getElementById('candidateHeaders'),hdrCount=document.getElementById('candidateCountHeader');
 const dist=calculateRealDistribution(phieuDetails,totalCandidates);
 const maxC=Math.max(...Object.keys(dist).map(Number));
 hdrCount.colSpan=maxC;hdr.innerHTML='';for(let i=1;i<=maxC;i++){const th=document.createElement('th');th.textContent=i+' ng∆∞·ªùi';hdr.appendChild(th);}
 const tr1=document.createElement('tr');const td1=document.createElement('td');td1.className='sub-header';td1.textContent='T·ªïng s·ªë phi·∫øu ƒë·∫°t';tr1.appendChild(td1);
 const tr2=document.createElement('tr');const td2=document.createElement('td');td2.className='sub-header';td2.textContent='ƒê·∫°t %';tr2.appendChild(td2);
 for(let i=1;i<=maxC;i++){const v=dist[i]||0;const p=calculatePercent(v,totalVotes);const tdv=document.createElement('td');tdv.textContent=v;tr1.appendChild(tdv);const tdp=document.createElement('td');tdp.textContent=p+'%';tr2.appendChild(tdp);}
 body.innerHTML='';body.appendChild(tr1);body.appendChild(tr2);
}

// -----------------------
// C·∫¨P NH·∫¨T B·∫¢NG K·∫æT QU·∫¢
// -----------------------
function updateElectionResultsTable(c){
 const tb=document.getElementById('electionResultsBody');tb.innerHTML='';
 if(c.length===0){tb.innerHTML='<tr><td colspan="5" style="text-align:center;color:#666;">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';return;}
 c.forEach(x=>{const tr=document.createElement('tr');if(x.rank<=3&&x.votes>0)tr.classList.add('highlight');tr.innerHTML=`<td>${x.stt}</td><td class="candidate-name">${x.name}</td><td>${x.votes}</td><td>${x.percent}%</td><td>${x.rank}</td>`;tb.appendChild(tr);});
}

// -----------------------
// LOAD & REALTIME DATA
// -----------------------
async function loadTongHopData(){
 try{
  const ungCuSnap=await db.ref(getUserPath('ungCu')).once('value');
  const kiemPhieuSnap=await db.ref(getUserPath('kiemPhieuData')).once('value');
  const phieuSnap=await db.ref(getUserPath('phieuDetails')).once('value');
  const resSnap=await db.ref(getUserPath('candidateResults')).once('value');
  updateAllTables(ungCuSnap,kiemPhieuSnap,phieuSnap,resSnap);
  updateConnectionStatus(true);
 }catch(e){console.error(e);updateConnectionStatus(false);}
}

function updateAllTables(ungCuSnap,kiemPhieuSnap,phieuSnap,resSnap){
 const candidateResults=resSnap.exists()?resSnap.val():{};
 const kiemPhieuData=kiemPhieuSnap.exists()?kiemPhieuSnap.val():{};
 let phieuDetails=[];
 if(phieuSnap.exists()){const d=phieuSnap.val();phieuDetails=Array.isArray(d)?d.filter(p=>p):Object.values(d);}
 const totalVotes=kiemPhieuData.soPhieuThuVao||0;
 document.getElementById('totalVotesDisplay').textContent=totalVotes;
 const cands=[];let stt=1;
 ungCuSnap.forEach(ch=>{const id=ch.key;const data=ch.val();const res=candidateResults[id]||{votes:0};cands.push({id,stt,name:data.hoTen||'Kh√¥ng c√≥ t√™n',votes:parseInt(res.votes)||0,percent:calculatePercent(parseInt(res.votes)||0,totalVotes)});stt++;});
 const totalC=cands.length;document.getElementById('totalCandidatesDisplay').textContent=totalC;
 cands.sort((a,b)=>b.votes-a.votes);cands.forEach((x,i)=>x.rank=i+1);
 updateElectionResultsTable(cands);
 updateVotesDistributionTable(phieuDetails,totalVotes,totalC);
 updateLastUpdateTime();
}

function refreshData(){loadTongHopData();}
function cleanupListeners(){realtimeListeners.forEach(fn=>fn&&fn());realtimeListeners=[];}

// -----------------------
// APP INIT
// -----------------------
function initApp(){
 auth.onAuthStateChanged(async(u)=>{
  if(u){currentUser=u;document.getElementById('userName').textContent=u.email||'Qu·∫£n tr·ªã vi√™n';document.getElementById('loading').style.display='none';document.getElementById('mainContent').style.display='block';await loadTongHopData();}
  else{document.getElementById('loading').innerHTML='Ch∆∞a ƒëƒÉng nh·∫≠p, ƒëang chuy·ªÉn h∆∞·ªõng...';setTimeout(()=>window.location.href='index.html',1500);}
 });
}

document.querySelectorAll('.nav-links a[data-target]').forEach(a=>{
 a.addEventListener('click',e=>{e.preventDefault();document.querySelectorAll('.nav-links a').forEach(x=>x.classList.remove('active'));a.classList.add('active');window.location.href=a.getAttribute('data-target')+'.html';});
});
document.getElementById('logout').addEventListener('click',e=>{e.preventDefault();if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')){cleanupListeners();auth.signOut().then(()=>{alert('ƒê√£ ƒëƒÉng xu·∫•t!');window.location.href='index.html';});}});
window.addEventListener('beforeunload', cleanupListeners);

// Kh·ªüi ƒë·ªông ·ª©ng d·ª•ng
window.onload = initApp;
</script>
</body>
</html>
