<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bi√™n b·∫£n k·∫øt qu·∫£ ki·ªÉm phi·∫øu</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Times New Roman', serif; }
        body { background-color: #f5f7fa; color: #000; font-size: 14px; line-height: 1.6; }
        .container { display: flex; min-height: 100vh; }
        .sidebar { width: 220px; background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; padding: 15px 0; box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1); }
        .logo { text-align: center; padding: 15px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 15px; }
        .logo h1 { font-size: 18px; font-weight: 600; }
        .nav-links { list-style: none; padding: 0 10px; }
        .nav-links li { margin-bottom: 8px; }
        .nav-links a { display: flex; align-items: center; padding: 10px 12px; color: white; text-decoration: none; border-radius: 6px; transition: all 0.3s ease; font-size: 13px; }
        .nav-links a:hover, .nav-links a.active { background-color: rgba(255, 255, 255, 0.1); }
        .main-content { flex: 1; padding: 20px; min-width: 0; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .header h2 { font-size: 20px; color: #2a5298; }
        .user-info { display: flex; align-items: center; background: white; padding: 8px 16px; border-radius: 25px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); font-size: 13px; }
        .user-info img { width: 32px; height: 32px; border-radius: 50%; margin-right: 8px; }

        .bien-ban-wrapper { background: white; padding: 40px; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1); max-width: 850px; margin: 20px auto; }
        .bb-header-top { display: flex; justify-content: space-between; font-weight: bold; }
        .bb-title { text-align: center; margin: 20px 0; }
        .bb-title h2 { font-size: 16px; font-weight: bold; text-transform: uppercase; }
        .bb-title p { font-size: 14px; font-weight: bold; }
        .bb-body p { margin-bottom: 10px; }
        .bb-list { padding-left: 20px; }
        .bb-results-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .bb-results-table td { padding: 5px; }
        .bb-signature { display: grid; grid-template-columns: 1fr 1fr; margin-top: 50px; text-align: center; gap: 20px; }
        .bb-signature .sig-block { display: flex; flex-direction: column; justify-content: space-between; }
        .bb-signature p { font-weight: bold; }
        .bb-signature .sig-role { font-style: italic; font-weight: normal; }
        .bb-footer { margin-top: 50px; }
        
        .btn { padding: 8px 16px; background: #2a5298; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: background 0.3s ease; margin-right: 10px; margin-bottom: 10px; }
        .btn:hover { background: #1e3c72; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .loading { text-align: center; padding: 20px; color: #666; font-size: 13px; }
        .action-buttons { display: flex; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }

        .placeholder { color: #888; }
        
        /* ========== Responsive cho tablet v√† ƒëi·ªán tho·∫°i ========== */

/* M√†n h√¨nh nh·ªè h∆°n laptop (tablet tr·ªü xu·ªëng) */
@media (max-width: 992px) {
  .container {
    flex-direction: column;
  }

  .sidebar {
    width: 100%;
    position: relative;
    height: auto;
    background: linear-gradient(135deg, #1e3c72, #2a5298);
    box-shadow: none;
    padding: 10px 0;
  }

  .nav-links {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
  }

  .nav-links li {
    margin: 5px;
  }

  .nav-links a {
    font-size: 13px;
    padding: 8px 10px;
    border-radius: 4px;
  }

  .main-content {
    padding: 15px;
    margin-left: 0;
  }

  .header {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }

  .header h2 {
    font-size: 18px;
    text-align: left;
  }

  .user-info {
    align-self: flex-end;
  }

  .bien-ban-wrapper {
    padding: 20px;
    margin: 10px auto;
    width: 100%;
  }

  .bb-signature {
    grid-template-columns: 1fr;
    gap: 30px;
  }
}

/* M√†n h√¨nh ƒëi·ªán tho·∫°i nh·ªè (d∆∞·ªõi 600px) */
@media (max-width: 600px) {
  body {
    font-size: 12px;
  }

  .logo h1 {
/* Responsive: hi·ªÉn th·ªã menu ngang tr√™n ƒëi·ªán tho·∫°i */
@media (max-width: 992px) {
  .container {
    flex-direction: column;
  }

  /* Sidebar bi·∫øn th√†nh thanh ƒëi·ªÅu h∆∞·ªõng ngang */
  .sidebar {
    width: 100%;
    height: auto;
    background: linear-gradient(135deg, #1e3c72, #2a5298);
    box-shadow: none;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-bottom: 10px;
  }

  .logo {
    border-bottom: none;
    margin-bottom: 5px;
    padding: 10px 0;
  }

  /* Menu n·∫±m ngang */
  .nav-links {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 6px;
    padding: 0 10px;
  }

  .nav-links li {
    margin: 0;
  }

  .nav-links a {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 8px 12px;
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    font-size: 13px;
    text-align: center;
  }

  .nav-links a.active {
    background-color: rgba(255, 255, 255, 0.25);
  }

  .main-content {
    padding: 15px;
    margin: 0;
  }

  .header {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }

  .bien-ban-wrapper {
    padding: 20px;
    margin: 15px auto;
    width: 100%;
  }

  .bb-signature {
    grid-template-columns: 1fr;
    gap: 30px;
  }
}

/* D∆∞·ªõi 600px: tinh ch·ªânh th√™m */
@media (max-width: 600px) {
  .nav-links a {
    font-size: 12px;
    padding: 6px 10px;
  }

  .logo h1 {
    font-size: 16px;
  }

  .btn {
    padding: 6px 10px;
    font-size: 12px;
  }

  .user-info span {
    display: none;
  }

  .bb-results-table {
    display: block;
    width: 100%;
    overflow-x: auto;
    font-size: 12px;
  }
}
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo"><h1>H·ªÜ TH·ªêNG B·∫¶U C·ª¨</h1></div>
            <ul class="nav-links">
                <li><a href="thongtin.html"><i>‚ÑπÔ∏è</i> Th√¥ng tin</a></li>
                <li><a href="kiemphieu.html"><i>‚úÖ</i> Ki·ªÉm phi·∫øu</a></li>
                <li><a href="tonghop.html"><i>üìà</i> T·ªïng h·ª£p</a></li>
                <li><a href="bienban.html" class="active"><i>üìù</i> Bi√™n b·∫£n</a></li>
                <li class="logout"><a href="#" id="logout"><i>üö™</i> ƒêƒÉng xu·∫•t</a></li>
            </ul>
        </div>

        <div class="main-content">
            <div class="header">
                <h2>Bi√™n b·∫£n k·∫øt qu·∫£ ki·ªÉm phi·∫øu</h2>
                <div class="user-info">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=2a5298&color=fff" alt="User">
                    <span id="userName">Qu·∫£n tr·ªã vi√™n</span>
                </div>
            </div>

            <div id="loading" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>

            <div id="mainContent" style="display: none;">
                <div class="action-buttons">
                    <button id="btnInBienBan" class="btn">In bi√™n b·∫£n</button>
                    <button id="btnTaiXuongWord" class="btn btn-success">T·∫£i xu·ªëng Word (.doc)</button>
                </div>

                <div id="bienBanContent" class="bien-ban-wrapper">
                    <div class="bb-header-top">
                        <p>T·ªânh/Th√†nh ph·ªë: <span id="tinhThanhBb" class="placeholder">...</span><br>X√£/Ph∆∞·ªùng/Th·ªã tr·∫•n: <span id="phuongXaBb" class="placeholder">...</span></p>
                        <p style="text-align: center;">C·ªòNG H√íA X√É H·ªòI CH·ª¶ NGHƒ®A VI·ªÜT NAM<br>ƒê·ªôc l·∫≠p - T·ª± do - H·∫°nh ph√∫c</p>
                    </div>

                    <div class="bb-title">
                        <h2>Bi√™n b·∫£n k·∫øt qu·∫£ ki·ªÉm phi·∫øu</h2>
                        <p>B·∫¶U C·ª¨ ƒê·∫†I BI·ªÇU H·ªòI ƒê·ªíNG NH√ÇN D√ÇN <span id="capBauCuBb" class="placeholder">...</span><br>KH√ìA <span id="khoaBb" class="placeholder">...</span> NHI·ªÜM K·ª≤ <span id="nhiemKyBb" class="placeholder">...</span></p>
                        <h3>C·ª¶A T·ªî B·∫¶U C·ª¨</h3>
                    </div>

                    <div class="bb-body">
                        <p>Khu v·ª±c b·ªè phi·∫øu s·ªë: <span id="khuVucBoPhieuBb" class="placeholder">...</span> X√£/Ph∆∞·ªùng/Th·ªã tr·∫•n: <span id="phuongXaBb2" class="placeholder">...</span></p>
                        <p>ƒê∆°n v·ªã b·∫ßu c·ª≠ ƒë·∫°i bi·ªÉu H·ªôi ƒë·ªìng nh√¢n d√¢n <span id="capBauCuBb2" class="placeholder">...</span> s·ªë: <span id="donViBauCuBb" class="placeholder">...</span></p>
                        <p>G·ªìm c√≥: <span id="gomCoBb" class="placeholder">...</span></p>
                        <p>H·ªìi ........ gi·ªù ......... ph√∫t, ng√†y ...... th√°ng ....... nƒÉm ......, T·ªï b·∫ßu c·ª≠ g·ªìm c√≥:</p>
                        <div id="danhSachKiemPhieuBb" class="bb-list">
                            <p class="placeholder">ƒêang t·∫£i danh s√°ch...</p>
                        </div>
                        <p>ƒê√£ h·ªçp t·∫°i ph√≤ng b·∫ßu c·ª≠ c·ªßa khu v·ª±c b·ªè phi·∫øu s·ªë: <span id="khuVucBoPhieuBb2" class="placeholder">...</span> x√£/ph∆∞·ªùng/th·ªã tr·∫•n: <span id="phuongXaBb3" class="placeholder">...</span> thu·ªôc ƒë∆°n v·ªã b·∫ßu c·ª≠ ƒë·∫°i bi·ªÉu H·ªôi ƒë·ªìng nh√¢n d√¢n s·ªë: <span id="donViBauCuBb2" class="placeholder">...</span> ƒë·ªÉ ti·∫øn h√†nh vi·ªác ki·ªÉm phi·∫øu b·∫ßu c·ª≠ ƒë·∫°i bi·ªÉu H·ªôi ƒë·ªìng nh√¢n d√¢n <span id="capBauCuBb3" class="placeholder">...</span> kh√≥a <span id="khoaBb2" class="placeholder">...</span> nhi·ªám k·ª≥ <span id="nhiemKyBb2" class="placeholder">...</span>.</p>
                        <p>ƒê√∫ng ........ gi·ªù ....... ph√∫t, ng√†y .... th√°ng .... nƒÉm ...., ƒë·∫°i di·ªán T·ªï b·∫ßu c·ª≠ ki·ªÉm tra h√≤m phi·∫øu v·ªõi s·ª± ch·ª©ng ki·∫øn c·ªßa hai c·ª≠ tri l√†:</p>
                        <div id="danhSachChungKienBb1" class="bb-list">
                            <p class="placeholder">ƒêang t·∫£i danh s√°ch...</p>
                        </div>
                        <p>Sau ƒë√≥, T·ªï b·∫ßu c·ª≠ ƒë√£ kho√° v√† ni√™m phong h√≤m phi·∫øu l·∫°i, m·ªùi c·ª≠ tri b·∫Øt ƒë·∫ßu b·∫ßu c·ª≠.</p>
                        <p>ƒê√∫ng ....... gi·ªù ...... ph√∫t ng√†y ...... th√°ng ...... nƒÉm ...., T·ªï tr∆∞·ªüng T·ªï b·∫ßu c·ª≠ tuy√™n b·ªë k·∫øt th√∫c cu·ªôc b·∫ßu c·ª≠ v√† ti·∫øn h√†nh ki·ªÉm phi·∫øu ngay t·∫°i ph√≤ng b·∫ßu c·ª≠.</p>
                        <p>Tr∆∞·ªõc khi m·ªü h√≤m phi·∫øu, T·ªï tr∆∞·ªüng T·ªï b·∫ßu c·ª≠ ƒë√£ m·ªùi hai c·ª≠ tri bi·∫øt ch·ªØ, kh√¥ng ph·∫£i l√† ng∆∞·ªùi ·ª©ng c·ª≠ ch·ª©ng ki·∫øn vi·ªác ki·ªÉm phi·∫øu g·ªìm:</p>
                         <div id="danhSachChungKienBb2" class="bb-list">
                            <p class="placeholder">ƒêang t·∫£i danh s√°ch...</p>
                        </div>
                        <p>Tr∆∞·ªõc khi m·ªü h√≤m phi·∫øu, T·ªï b·∫ßu c·ª≠ ƒë√£ ti·∫øn h√†nh ki·ªÉm k√™ v√† l·∫≠p bi√™n b·∫£n v·ªÅ vi·ªác s·ª≠ d·ª•ng phi·∫øu b·∫ßu c·ª≠ ƒë·∫°i bi·ªÉu H·ªôi ƒë·ªìng nh√¢n d√¢n c√°c c·∫•p.</p>
                        <p><strong>K·∫øt qu·∫£ cu·ªôc b·∫ßu c·ª≠ nh∆∞ sau:</strong></p>
                        <table class="bb-results-table">
                            <tr><td>- S·ªë ƒë·∫°i bi·ªÉu H·ªôi ƒë·ªìng nh√¢n d√¢n ·∫•n ƒë·ªãnh cho ƒë∆°n v·ªã b·∫ßu c·ª≠:</td><td><span id="soNguoiDuocBauBb" class="placeholder">0</span> ng∆∞·ªùi</td></tr>
                            <tr><td>- S·ªë ng∆∞·ªùi ·ª©ng c·ª≠:</td><td><span id="soNguoiUngCuBb" class="placeholder">0</span> ng∆∞·ªùi</td></tr>
                            <tr><td>- T·ªïng s·ªë c·ª≠ tri c·ªßa khu v·ª±c b·ªè phi·∫øu:</td><td><span id="tongSoCuTriBb" class="placeholder">0</span> ng∆∞·ªùi</td></tr>
                            <tr><td>- S·ªë c·ª≠ tri ƒë√£ tham gia b·ªè phi·∫øu:</td><td><span id="thamGiaBoPhieuBb" class="placeholder">0</span> ng∆∞·ªùi</td></tr>
                            <tr><td>- T·ª∑ l·ªá c·ª≠ tri ƒë√£ tham gia b·∫ßu phi·∫øu so v·ªõi t·ªïng s·ªë c·ª≠ tri:</td><td><span id="phanTramThamGiaBb" class="placeholder">0%</span></td></tr>
                            <tr><td>- S·ªë phi·∫øu ph√°t ra:</td><td><span id="soPhieuPhatRaBb" class="placeholder">0</span></td></tr>
                            <tr><td>- S·ªë phi·∫øu thu v√†o:</td><td><span id="soPhieuThuVaoBb" class="placeholder">0</span></td></tr>
                            <tr><td>- S·ªë phi·∫øu h·ª£p l·ªá:</td><td><span id="soPhieuHopLeBb" class="placeholder">0</span> (T·ª∑ l·ªá: <span id="phanTramHopLeBb" class="placeholder">0%</span>)</td></tr>
                            <tr><td>- S·ªë phi·∫øu kh√¥ng h·ª£p l·ªá:</td><td><span id="soPhieuKhongHopLeBb" class="placeholder">0</span> (T·ª∑ l·ªá: <span id="phanTramKhongHopLeBb" class="placeholder">0%</span>)</td></tr>
                        </table>
                        <p><strong>- S·ªë phi·∫øu b·∫ßu cho m·ªói ng∆∞·ªùi ·ª©ng c·ª≠:</strong></p>
                        <div id="ketQuaUngVienContainer" class="bb-list">
                           <p class="placeholder">ƒêang t·∫£i k·∫øt qu·∫£...</p>
                        </div>
                        <p>Trong ng√†y b·∫ßu c·ª≠ v√† th·ªùi gian ki·ªÉm phi·∫øu, ƒë√£ x·∫£y ra s·ª± vi·ªác ho·∫∑c khi·∫øu n·∫°i, t·ªë c√°o sau ƒë√¢y: ....................................................................................................................................................</p>
                        <p>Nh·ªØng v·∫•n ƒë·ªÅ ho·∫∑c khi·∫øu n·∫°i, t·ªë c√°o ch∆∞a ƒë∆∞·ª£c gi·∫£i quy·∫øt v√† ki·∫øn ngh·ªã: ....................................................................................................................................................</p>
                        <p>Bi√™n b·∫£n n√†y ƒë∆∞·ª£c l·∫≠p th√†nh 03 b·∫£n v√† ƒë∆∞·ª£c g·ª≠i ƒë·∫øn Ban b·∫ßu c·ª≠ ƒë·∫°i bi·ªÉu H·ªôi ƒë·ªìng nh√¢n d√¢n <span id="capBauCuBb4" class="placeholder">...</span> v√† ·ª¶y ban nh√¢n d√¢n, Ban th∆∞·ªùng tr·ª±c ·ª¶y ban M·∫∑t tr·∫≠n T·ªï qu·ªëc Vi·ªát Nam c·∫•p x√£.</p>
                    </div>

                    <div class="bb-signature">
                        <div class="sig-block">
                            <p>C·ª¨ TRI TH·ª® NH·∫§T CH·ª®NG KI·∫æN</p>
                            <p class="sig-role">(K√Ω, ghi r√µ h·ªç t√™n)</p>
                        </div>
                         <div class="sig-block">
                            <p>TM. T·ªî B·∫¶U C·ª¨</p>
                            <p>T·ªî TR∆Ø·ªûNG</p>
                            <p class="sig-role">(K√Ω t√™n v√† ƒë√≥ng d·∫•u)</p>
                        </div>
                         <div class="sig-block">
                            <p>C·ª¨ TRI TH·ª® HAI CH·ª®NG KI·∫æN</p>
                            <p class="sig-role">(K√Ω, ghi r√µ h·ªç t√™n)</p>
                        </div>
                         <div class="sig-block">
                            <p>TH∆Ø K√ù T·ªî B·∫¶U C·ª¨</p>
                             <p class="sig-role">(K√Ω, ghi r√µ h·ªç t√™n)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyAt-OooTscmthbJXNcvy80RgPDA9T46-0w", 
            authDomain: "kiemphieu-45823.firebaseapp.com", 
            databaseURL: "https://kiemphieu-45823-default-rtdb.asia-southeast1.firebasedatabase.app", 
            projectId: "kiemphieu-45823", 
            storageBucket: "kiemphieu-45823.firebasestorage.app", 
            messagingSenderId: "908329514571", 
            appId: "1:908329514571:web:16b43df5b795e4de06bfce" 
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        let currentUser = null;

        function getUserPath(path = '') {
            if (!currentUser || !currentUser.uid) throw new Error('User not authenticated');
            return `users/${currentUser.uid}${path ? '/' + path : ''}`;
        }
        
        function fillText(id, value, defaultValue = '...') {
             const elements = document.querySelectorAll(`#${id}`);
             elements.forEach(el => el.textContent = value || defaultValue);
        }

        async function loadBienBanData() {
            try {
                const [donViSnap, kiemPhieuDataSnap, dsKiemPhieuSnap, dsChungKienSnap, ungCuSnap, candidateResultsSnap] = await Promise.all([
                    db.ref(getUserPath('donVi')).once('value'),
                    db.ref(getUserPath('kiemPhieuData')).once('value'),
                    db.ref(getUserPath('kiemPhieu')).once('value'),
                    db.ref(getUserPath('chungKien')).once('value'),
                    db.ref(getUserPath('ungCu')).once('value'),
                    db.ref(getUserPath('candidateResults')).once('value')
                ]);

                // Process "donVi" data
                if (donViSnap.exists()) {
                    const data = donViSnap.val();
                    fillText('tinhThanhBb', data.tinhThanh);
                    fillText('phuongXaBb', data.phuongXa);
                    fillText('phuongXaBb2', data.phuongXa);
                    fillText('phuongXaBb3', data.phuongXa);
                    fillText('khoaBb', data.khoa);
                    fillText('khoaBb2', data.khoa);
                    fillText('nhiemKyBb', data.nhiemKy);
                    fillText('nhiemKyBb2', data.nhiemKy);
                    fillText('khuVucBoPhieuBb', data.khuVucBoPhieu);
                    fillText('khuVucBoPhieuBb2', data.khuVucBoPhieu);
                    fillText('donViBauCuBb', data.donViBauCu);
                    fillText('donViBauCuBb2', data.donViBauCu);
                    fillText('gomCoBb', data.gomCo);
                    fillText('soNguoiUngCuBb', data.soNguoiUngCu, 0);
                    fillText('soNguoiDuocBauBb', data.soNguoiDuocBau, 0);

                    const capText = data.bauCuCap ? { 'quoc_hoi': 'Qu·ªëc h·ªôi', 'thanh_pho': 'Th√†nh ph·ªë', 'phuong': 'Ph∆∞·ªùng' }[data.bauCuCap] || data.bauCuCap : '...';
                    fillText('capBauCuBb', capText);
                    fillText('capBauCuBb2', capText);
                    fillText('capBauCuBb3', capText);
                    fillText('capBauCuBb4', capText);
                }

                // Process "kiemPhieuData"
                let tongPhieuThuVao = 0;
                let soPhieuHopLe = 0; // Defaulting to total votes
                if (kiemPhieuDataSnap.exists()) {
                    const data = kiemPhieuDataSnap.val();
                    tongPhieuThuVao = parseInt(data.soPhieuThuVao) || 0;
                    soPhieuHopLe = tongPhieuThuVao; // Assuming all votes are valid for now
                    
                    fillText('tongSoCuTriBb', data.tongSoCuTri, 0);
                    fillText('thamGiaBoPhieuBb', data.thamGiaBoPhieu, 0);
                    fillText('phanTramThamGiaBb', data.phanTramThamGia, '0%');
                    fillText('soPhieuPhatRaBb', data.soPhieuPhatRa, 0);
                    fillText('soPhieuThuVaoBb', data.soPhieuThuVao, 0);
                    fillText('soPhieuHopLeBb', soPhieuHopLe, 0);
                    fillText('soPhieuKhongHopLeBb', 0); // Placeholder
                    
                    const phanTramHopLe = tongPhieuThuVao > 0 ? '100%' : '0%'; // Simplified
                    fillText('phanTramHopLeBb', phanTramHopLe);
                    fillText('phanTramKhongHopLeBb', '0%'); // Simplified
                }

                // Process list of "kiemPhieu"
                const dsKiemPhieuDiv = document.getElementById('danhSachKiemPhieuBb');
                dsKiemPhieuDiv.innerHTML = '';
                if (dsKiemPhieuSnap.exists()) {
                    let stt = 1;
                    dsKiemPhieuSnap.forEach(child => {
                        const data = child.val();
                        dsKiemPhieuDiv.innerHTML += `<p>${stt}. √îng/B√† ${data.hoTen || ''} - ${data.chucVu || '·ª¶y vi√™n'}</p>`;
                        stt++;
                    });
                } else { dsKiemPhieuDiv.innerHTML = '<p class="placeholder">Kh√¥ng c√≥ d·ªØ li·ªáu ng∆∞·ªùi ki·ªÉm phi·∫øu.</p>'; }

                // Process list of "chungKien" for both sections
                const dsChungKienDiv1 = document.getElementById('danhSachChungKienBb1');
                const dsChungKienDiv2 = document.getElementById('danhSachChungKienBb2');
                dsChungKienDiv1.innerHTML = '';
                dsChungKienDiv2.innerHTML = '';
                 if (dsChungKienSnap.exists()) {
                    let stt = 1;
                    let htmlContent = '';
                    dsChungKienSnap.forEach(child => {
                        const data = child.val();
                        htmlContent += `<p>${stt}. √îng/B√†: ${data.hoTen || ''} - N∆°i ·ªü hi·ªán nay: ${data.diaChi || ''}</p>`;
                        stt++;
                    });
                    dsChungKienDiv1.innerHTML = htmlContent;
                    dsChungKienDiv2.innerHTML = htmlContent;
                } else { 
                    const noDataMsg = '<p class="placeholder">Kh√¥ng c√≥ d·ªØ li·ªáu ng∆∞·ªùi ch·ª©ng ki·∫øn.</p>';
                    dsChungKienDiv1.innerHTML = noDataMsg;
                    dsChungKienDiv2.innerHTML = noDataMsg;
                }
                
                // Process candidate results
                const ketQuaUngVienContainer = document.getElementById('ketQuaUngVienContainer');
                ketQuaUngVienContainer.innerHTML = '';
                const ungCuData = ungCuSnap.exists() ? ungCuSnap.val() : {};
                const candidateResultsData = candidateResultsSnap.exists() ? candidateResultsSnap.val() : {};
                
                let resultsHtml = '';
                Object.keys(ungCuData).forEach(key => {
                    const hoTen = ungCuData[key].hoTen;
                    const result = candidateResultsData[key] || { soPhieu: 0 };
                    resultsHtml += `<p>√îng/B√† ${hoTen} ƒë∆∞·ª£c ${result.votes} phi·∫øu / ${soPhieuHopLe} phi·∫øu h·ª£p l·ªá</p>`;
                });
                ketQuaUngVienContainer.innerHTML = resultsHtml || '<p class="placeholder">Ch∆∞a c√≥ k·∫øt qu·∫£.</p>';

            } catch (error) {
                console.error('Error loading data:', error);
                alert('L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message);
            }
        }
        
        function exportToWord() {
            const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Bi√™n b·∫£n</title></head><body>";
            const footer = "</body></html>";
            const sourceHTML = header + document.getElementById('bienBanContent').innerHTML + footer;
            
            const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
            const fileDownload = document.createElement("a");
            document.body.appendChild(fileDownload);
            fileDownload.href = source;
            const khuVucSo = document.getElementById('khuVucBoPhieuBb').textContent || 'X';
            fileDownload.download = `bien_ban_khu_vuc_so_${khuVucSo}.doc`;
            fileDownload.click();
            document.body.removeChild(fileDownload);
        }

        document.getElementById('btnInBienBan').addEventListener('click', () => window.print());
        document.getElementById('btnTaiXuongWord').addEventListener('click', exportToWord);

        auth.onAuthStateChanged(async (user) => {
            const loadingElement = document.getElementById('loading');
            const mainContentElement = document.getElementById('mainContent');
            if (user) {
                currentUser = user;
                document.getElementById('userName').textContent = user.email || 'Qu·∫£n tr·ªã vi√™n';
                await loadBienBanData();
                loadingElement.style.display = 'none';
                mainContentElement.style.display = 'block';
            } else {
                loadingElement.innerHTML = 'Ch∆∞a ƒëƒÉng nh·∫≠p. ƒêang chuy·ªÉn h∆∞·ªõng...';
                setTimeout(() => { window.location.href = 'index.html'; }, 2000);
            }
        });
        
        document.getElementById('logout').addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                auth.signOut().then(() => { window.location.href = 'index.html'; });
            }
        });
    </script>
</body>
</html>
