<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bi√™n b·∫£n k·∫øt qu·∫£ ki·ªÉm phi·∫øu</title>
<style>
    * {margin: 0; padding: 0; box-sizing: border-box;}
    body {
        font-family: "Segoe UI", Roboto, Arial, sans-serif;
        background-color: #f5f7fa;
        color: #222;
        line-height: 1.6;
        font-size: 16px;
    }

    .wrapper {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        border-radius: 10px;
        padding: 20px;
    }

    h1, h2, h3 {
        text-align: center;
        color: #1e3c72;
        margin-bottom: 8px;
    }

    .sub {
        text-align: center;
        font-weight: bold;
        color: #444;
        margin-bottom: 15px;
    }

    .info p {margin-bottom: 5px;}

    .result-list p {
        background: #f1f3f6;
        padding: 10px;
        margin: 6px 0;
        border-radius: 6px;
    }

    .footer {
        margin-top: 25px;
        text-align: center;
        font-style: italic;
        font-size: 14px;
        color: #666;
    }

    .btn-group {
        text-align: center;
        margin-bottom: 20px;
    }

    button {
        padding: 10px 18px;
        background: #2a5298;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 15px;
        margin: 5px;
        cursor: pointer;
    }

    button:hover {background: #1e3c72;}

    @media (max-width: 600px) {
        body {font-size: 15px;}
        .wrapper {padding: 15px;}
        button {width: 100%;}
    }
</style>
</head>
<body>

<div class="wrapper">
    <h2>BI√äN B·∫¢N K·∫æT QU·∫¢ KI·ªÇM PHI·∫æU</h2>
    <div class="sub">B·∫¶U C·ª¨ ƒê·∫†I BI·ªÇU H·ªòI ƒê·ªíNG NH√ÇN D√ÇN</div>

    <div class="info">
        <p><b>ƒê∆°n v·ªã:</b> <span id="tinhThanhBb">...</span></p>
        <p><b>X√£/Ph∆∞·ªùng:</b> <span id="phuongXaBb">...</span></p>
    </div>

    <div class="btn-group">
        <button id="btnInBienBan">üñ®Ô∏è In bi√™n b·∫£n</button>
        <button id="btnTaiXuongWord">‚¨áÔ∏è T·∫£i xu·ªëng</button>
    </div>

    <p><b>S·ªë phi·∫øu b·∫ßu cho m·ªói ng∆∞·ªùi ·ª©ng c·ª≠:</b></p>
    <div id="ketQuaUngVienContainer" class="result-list">
        <p>ƒêang t·∫£i k·∫øt qu·∫£...</p>
    </div>

    <div class="footer">
        C·ªông h√≤a X√£ h·ªôi Ch·ªß nghƒ©a Vi·ªát Nam ‚Äî ƒê·ªôc l·∫≠p, T·ª± do, H·∫°nh ph√∫c
    </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = { 
    apiKey: "AIzaSyAt-OooTscmthbJXNcvy80RgPDA9T46-0w", 
    authDomain: "kiemphieu-45823.firebaseapp.com", 
    databaseURL: "https://kiemphieu-45823-default-rtdb.asia-southeast1.firebasedatabase.app", 
    projectId: "kiemphieu-45823", 
    storageBucket: "kiemphieu-45823.firebasestorage.app", 
    messagingSenderId: "908329514571", 
    appId: "1:908329514571:web:16b43df5b795e4de06bfce" 
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();
let currentUser = null;

function getUserPath(path = '') {
    if (!currentUser || !currentUser.uid) throw new Error('User not authenticated');
    return `users/${currentUser.uid}${path ? '/' + path : ''}`;
}

async function loadBienBanData() {
    const [ungCuSnap, kiemPhieuDataSnap] = await Promise.all([
        db.ref(getUserPath('ungCu')).once('value'),
        db.ref(getUserPath('kiemPhieuData')).once('value')
    ]);

    const ketQuaUngVienContainer = document.getElementById('ketQuaUngVienContainer');
    ketQuaUngVienContainer.innerHTML = '';

    const ungCuData = ungCuSnap.exists() ? ungCuSnap.val() : {};
    let phieuDetails = [];
    let soPhieuHopLe = 0;

    const phieuSnap = await db.ref(getUserPath('phieuDetails')).once('value');
    if (phieuSnap.exists()) {
        const raw = phieuSnap.val();
        phieuDetails = Array.isArray(raw) ? raw.filter(p => p !== null) : Object.values(raw);
        soPhieuHopLe = phieuDetails.filter(p => p.trangThai === 'H·ª£p l·ªá').length;
    }

    if (soPhieuHopLe === 0 && kiemPhieuDataSnap.exists()) {
        const data = kiemPhieuDataSnap.val();
        soPhieuHopLe = parseInt(data.soPhieuThuVao) || 0;
    }

    const tongPhieuTheoUngVien = {};
    Object.keys(ungCuData).forEach(key => tongPhieuTheoUngVien[key] = 0);

    phieuDetails.forEach(phieu => {
        if (phieu.trangThai === 'H·ª£p l·ªá') {
            Object.keys(ungCuData).forEach(key => {
                if (!phieu.selectedIds.includes(key)) tongPhieuTheoUngVien[key]++;
            });
        }
    });

    let resultsHtml = '';
    Object.keys(ungCuData).forEach(key => {
        const hoTen = ungCuData[key].hoTen || '(Kh√¥ng t√™n)';
        const tongPhieu = tongPhieuTheoUngVien[key] || 0;
        resultsHtml += `<p>√îng/B√† <b>${hoTen}</b> ƒë∆∞·ª£c <b>${tongPhieu}</b> phi·∫øu / ${soPhieuHopLe} phi·∫øu h·ª£p l·ªá</p>`;
    });

    ketQuaUngVienContainer.innerHTML = resultsHtml || '<p>Ch∆∞a c√≥ k·∫øt qu·∫£.</p>';
}

auth.onAuthStateChanged(async (user) => {
    if (user) {
        currentUser = user;
        await loadBienBanData();
    } else {
        document.getElementById('ketQuaUngVienContainer').innerHTML = '<p>Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.</p>';
    }
});
</script>

</body>
</html>
