<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bi√™n b·∫£n k·∫øt qu·∫£ ki·ªÉm phi·∫øu</title>
    <style>
        /* CSS styles remain the same as your original bienban.html file */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Times New Roman', serif;
        }

        body {
            background-color: #f5f7fa;
            color: #000;
            font-size: 14px;
            line-height: 1.4;
        }

        .container { display: flex; min-height: 100vh; }
        .sidebar { width: 220px; background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; padding: 15px 0; box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1); }
        .logo { text-align: center; padding: 15px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 15px; }
        .logo h1 { font-size: 18px; font-weight: 600; }
        .nav-links { list-style: none; padding: 0 10px; }
        .nav-links li { margin-bottom: 8px; }
        .nav-links a { display: flex; align-items: center; padding: 10px 12px; color: white; text-decoration: none; border-radius: 6px; transition: all 0.3s ease; font-size: 13px; }
        .nav-links a:hover, .nav-links a.active { background-color: rgba(255, 255, 255, 0.1); }
        .nav-links i { margin-right: 8px; font-size: 16px; }
        .logout { margin-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1); padding-top: 15px; }

        .main-content { flex: 1; padding: 20px; min-width: 0; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .header h2 { font-size: 20px; color: #2a5298; }
        .user-info { display: flex; align-items: center; background: white; padding: 8px 16px; border-radius: 25px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); font-size: 13px; }
        .user-info img { width: 32px; height: 32px; border-radius: 50%; margin-right: 8px; }

        .bien-ban {
            background: white;
            padding: 30px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .bien-ban-header { display: flex; justify-content: space-between; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
        .bien-ban-title { text-align: center; font-weight: bold; font-size: 16px; margin: 20px 0; text-transform: uppercase; }
        .bien-ban-section { margin-bottom: 20px; }
        .bien-ban-section h3 { font-size: 14px; margin-bottom: 10px; text-decoration: underline; }
        .bien-ban-table { width: 100%; border-collapse: collapse; margin: 15px 0; font-size: 13px; }
        .bien-ban-table th, .bien-ban-table td { border: 1px solid #000; padding: 8px 10px; text-align: left; }
        .bien-ban-table th { background-color: #f0f0f0; }
        .bien-ban-signature { display: flex; justify-content: space-between; margin-top: 50px; flex-wrap: wrap; gap: 20px; }
        .signature-block { text-align: center; width: 30%; min-width: 150px; }
        .signature-line { margin-top: 50px; }
        .btn { padding: 8px 16px; background: #2a5298; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: background 0.3s ease; margin-right: 10px; margin-bottom: 10px; }
        .btn:hover { background: #1e3c72; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .loading { text-align: center; padding: 20px; color: #666; font-size: 13px; }
        .action-buttons { display: flex; justify-content: center; margin-top: 20px; flex-wrap: wrap; gap: 10px; }

        @media print {
            .sidebar, .header, .action-buttons, .mobile-header, .mobile-sidebar {
                display: none !important;
            }
            .main-content { padding: 0; }
            .bien-ban { box-shadow: none; padding: 0; margin: 0; max-width: none; border: none; }
            body { background: white; font-size: 12pt; }
        }
        
        /* Other responsive styles remain the same */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { padding: 80px 15px 20px 15px; }
        }

        .text-center { text-align: center; }
        .mb-10 { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
             <div class="logo"><h1>H·ªÜ TH·ªêNG B·∫¶U C·ª¨</h1></div>
            <ul class="nav-links">
                <li><a href="thongtin.html"><i>‚ÑπÔ∏è</i> Th√¥ng tin</a></li>
                <li><a href="kiemphieu.html"><i>‚úÖ</i> Ki·ªÉm phi·∫øu</a></li>
                <li><a href="#"><i>üìà</i> T·ªïng h·ª£p</a></li>
                <li><a href="bienban.html" class="active"><i>üìù</i> Bi√™n b·∫£n</a></li>
                <li class="logout"><a href="#" id="logout"><i>üö™</i> ƒêƒÉng xu·∫•t</a></li>
            </ul>
        </div>

        <div class="main-content">
            <div class="header">
                <h2>Bi√™n b·∫£n k·∫øt qu·∫£ ki·ªÉm phi·∫øu</h2>
                <div class="user-info">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=2a5298&color=fff" alt="User">
                    <span id="userName">Qu·∫£n tr·ªã vi√™n</span>
                </div>
            </div>

            <div id="loading" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>

            <div id="mainContent" style="display: none;">
                <div class="action-buttons">
                    <button id="btnInBienBan" class="btn">In bi√™n b·∫£n</button>
                    <button id="btnTaiXuongWord" class="btn btn-success">T·∫£i xu·ªëng Word (.doc)</button>
                </div>

                <div id="bienBanContent" class="bien-ban">
                    <div class="bien-ban-header">
                        <div>
                            <p>T·ªânh/Th√†nh ph·ªë: <span id="tinhThanhBb"></span></p>
                            <p>X√£/Ph∆∞·ªùng/Th·ªã tr·∫•n: <span id="phuongXaBb"></span></p>
                        </div>
                        <div class="text-center">
                            <p><strong>C·ªòNG H√íA X√É H·ªòI CH·ª¶ NGHƒ®A VI·ªÜT NAM</strong></p>
                            <p><strong>ƒê·ªôc l·∫≠p - T·ª± do - H·∫°nh ph√∫c</strong></p>
                        </div>
                    </div>

                    <div class="bien-ban-title">
                        BI√äN B·∫¢N K·∫æT QU·∫¢ KI·ªÇM PHI·∫æU<br>
                        B·∫¶U C·ª¨ ƒê·∫†I BI·ªÇU H·ªòI ƒê·ªíNG NH√ÇN D√ÇN <span id="capBauCuBb"></span><br>
                        KH√ìA <span id="khoaBb"></span> - NHI·ªÜM K·ª≤ <span id="nhiemKyBb"></span>
                    </div>

                    <div class="bien-ban-section">
                        <p>Khu v·ª±c b·ªè phi·∫øu s·ªë: <span id="khuVucBoPhieuBb"></span> - X√£/Ph∆∞·ªùng/Th·ªã tr·∫•n: <span id="phuongXaBb2"></span></p>
                        <p>ƒê∆°n v·ªã b·∫ßu c·ª≠ ƒë·∫°i bi·ªÉu H·ªôi ƒë·ªìng nh√¢n d√¢n <span id="capBauCuBb2"></span> s·ªë: <span id="donViBauCuBb"></span></p>
                        <p>G·ªìm c√≥: <span id="gomCoBb"></span></p>
                        
                        <p class="mb-10">H·ªìi .... gi·ªù .... ph√∫t, ng√†y .... th√°ng .... nƒÉm ...., T·ªï b·∫ßu c·ª≠ g·ªìm c√≥:</p>
                        
                        <div id="danhSachKiemPhieuBb">
                            </div>
                    </div>

                    <div class="bien-ban-section">
                        <p class="mb-10">ƒê√∫ng .... gi·ªù .... ph√∫t, ng√†y .... th√°ng .... nƒÉm ...., T·ªï tr∆∞·ªüng T·ªï b·∫ßu c·ª≠ tuy√™n b·ªë k·∫øt th√∫c cu·ªôc b·∫ßu c·ª≠ v√† ti·∫øn h√†nh ki·ªÉm phi·∫øu ngay t·∫°i ph√≤ng b·∫ßu c·ª≠.</p>
                        
                        <p class="mb-10">Tr∆∞·ªõc khi m·ªü h√≤m phi·∫øu, T·ªï tr∆∞·ªüng T·ªï b·∫ßu c·ª≠ ƒë√£ m·ªùi hai c·ª≠ tri bi·∫øt ch·ªØ, kh√¥ng ph·∫£i l√† ng∆∞·ªùi ·ª©ng c·ª≠ ch·ª©ng ki·∫øn vi·ªác ki·ªÉm phi·∫øu g·ªìm:</p>
                        
                        <div id="danhSachChungKienBb">
                            </div>
                    </div>

                    <div class="bien-ban-section">
                        <h3>K·∫æT QU·∫¢ CU·ªòC B·∫¶U C·ª¨ NH∆Ø SAU:</h3>
                        <table class="bien-ban-table">
                            <tr><td>S·ªë ƒë·∫°i bi·ªÉu H·ªôi ƒë·ªìng nh√¢n d√¢n ·∫•n ƒë·ªãnh cho ƒë∆°n v·ªã b·∫ßu c·ª≠</td><td id="soNguoiDuocBauBb"></td></tr>
                            <tr><td>S·ªë ng∆∞·ªùi ·ª©ng c·ª≠</td><td id="soNguoiUngCuBb"></td></tr>
                            <tr><td>T·ªïng s·ªë c·ª≠ tri c·ªßa khu v·ª±c b·ªè phi·∫øu</td><td id="tongSoCuTriBb"></td></tr>
                            <tr><td>S·ªë c·ª≠ tri ƒë√£ tham gia b·ªè phi·∫øu</td><td id="thamGiaBoPhieuBb"></td></tr>
                            <tr><td>T·ª∑ l·ªá c·ª≠ tri ƒë√£ tham gia b·∫ßu phi·∫øu so v·ªõi t·ªïng s·ªë c·ª≠ tri</td><td id="phanTramThamGiaBb"></td></tr>
                            <tr><td>S·ªë phi·∫øu ph√°t ra</td><td id="soPhieuPhatRaBb"></td></tr>
                            <tr><td>S·ªë phi·∫øu thu v√†o</td><td id="soPhieuThuVaoBb"></td></tr>
                            <tr><td>S·ªë phi·∫øu h·ª£p l·ªá</td><td id="soPhieuHopLeBb"></td></tr>
                            <tr><td>S·ªë phi·∫øu kh√¥ng h·ª£p l·ªá</td><td id="soPhieuKhongHopLeBb"></td></tr>
                        </table>
                    </div>

                    <div class="bien-ban-section">
                        <h3>S·ªê PHI·∫æU B·∫¶U CHO M·ªñI NG∆Ø·ªúI ·ª®NG C·ª¨:</h3>
                        <div id="ketQuaUngVienContainer">
                            </div>
                    </div>

                    <div class="bien-ban-signature">
                        <div class="signature-block">
                            <p><strong>C·ª¨ TRI TH·ª® NH·∫§T CH·ª®NG KI·∫æN</strong></p>
                            <p>(K√Ω, ghi r√µ h·ªç t√™n)</p>
                        </div>
                        <div class="signature-block">
                             <p><strong>TM. T·ªî B·∫¶U C·ª¨</strong></p>
                            <p><strong>T·ªî TR∆Ø·ªû·ªûNG</strong></p>
                            <p>(K√Ω t√™n v√† ƒë√≥ng d·∫•u)</p>
                        </div>
                        <div class="signature-block">
                            <p><strong>TH∆Ø K√ù</strong></p>
                            <p><strong>T·ªî B·∫¶U C·ª¨</strong></p>
                             <p>(K√Ω, ghi r√µ h·ªç t√™n)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyAt-OooTscmthbJXNcvy80RgPDA9T46-0w", 
            authDomain: "kiemphieu-45823.firebaseapp.com", 
            databaseURL: "https://kiemphieu-45823-default-rtdb.asia-southeast1.firebasedatabase.app", 
            projectId: "kiemphieu-45823", 
            storageBucket: "kiemphieu-45823.firebasestorage.app", 
            messagingSenderId: "908329514571", 
            appId: "1:908329514571:web:16b43df5b795e4de06bfce" 
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        let currentUser = null;

        function getUserPath(path = '') {
            if (!currentUser || !currentUser.uid) throw new Error('User not authenticated');
            return `users/${currentUser.uid}${path ? '/' + path : ''}`;
        }

        async function loadBienBanData() {
            try {
                // Fetch all data concurrently for better performance
                const [donViSnap, kiemPhieuDataSnap, dsKiemPhieuSnap, dsChungKienSnap, ungCuSnap, candidateResultsSnap] = await Promise.all([
                    db.ref(getUserPath('donVi')).once('value'),
                    db.ref(getUserPath('kiemPhieuData')).once('value'),
                    db.ref(getUserPath('kiemPhieu')).once('value'),
                    db.ref(getUserPath('chungKien')).once('value'),
                    db.ref(getUserPath('ungCu')).once('value'),
                    db.ref(getUserPath('candidateResults')).once('value')
                ]);

                // 1. Process "donVi" data from thongtin.html
                if (donViSnap.exists()) {
                    const data = donViSnap.val();
                    document.getElementById('tinhThanhBb').textContent = data.tinhThanh || '...';
                    document.getElementById('phuongXaBb').textContent = data.phuongXa || '...';
                    document.getElementById('phuongXaBb2').textContent = data.phuongXa || '...';
                    document.getElementById('khoaBb').textContent = data.khoa || '...';
                    document.getElementById('nhiemKyBb').textContent = data.nhiemKy || '...';
                    document.getElementById('khuVucBoPhieuBb').textContent = data.khuVucBoPhieu || '...';
                    document.getElementById('donViBauCuBb').textContent = data.donViBauCu || '...';
                    document.getElementById('gomCoBb').textContent = data.gomCo || '...';
                    document.getElementById('soNguoiUngCuBb').textContent = data.soNguoiUngCu || 0;
                    document.getElementById('soNguoiDuocBauBb').textContent = data.soNguoiDuocBau || 0;

                    const capText = data.bauCuCap ? { 'quoc_hoi': 'Qu·ªëc h·ªôi', 'thanh_pho': 'Th√†nh ph·ªë', 'phuong': 'Ph∆∞·ªùng' }[data.bauCuCap] || data.bauCuCap : '...';
                    document.getElementById('capBauCuBb').textContent = capText;
                    document.getElementById('capBauCuBb2').textContent = capText;
                }

                // 2. Process "kiemPhieuData" from kiemphieu.html
                if (kiemPhieuDataSnap.exists()) {
                    const data = kiemPhieuDataSnap.val();
                    document.getElementById('tongSoCuTriBb').textContent = data.tongSoCuTri || 0;
                    document.getElementById('thamGiaBoPhieuBb').textContent = data.thamGiaBoPhieu || 0;
                    document.getElementById('phanTramThamGiaBb').textContent = data.phanTramThamGia || '0%';
                    document.getElementById('soPhieuPhatRaBb').textContent = data.soPhieuPhatRa || 0;
                    document.getElementById('soPhieuThuVaoBb').textContent = data.soPhieuThuVao || 0;
                    
                    // Assuming total votes collected are valid votes for now
                    // You might need to add a specific field for invalid votes
                    document.getElementById('soPhieuHopLeBb').textContent = data.soPhieuThuVao || 0;
                    document.getElementById('soPhieuKhongHopLeBb').textContent = 0; // Placeholder
                }

                // 3. Process list of "kiemPhieu" from thongtin.html
                const dsKiemPhieuDiv = document.getElementById('danhSachKiemPhieuBb');
                dsKiemPhieuDiv.innerHTML = '';
                if (dsKiemPhieuSnap.exists()) {
                    let stt = 1;
                    dsKiemPhieuSnap.forEach(child => {
                        const data = child.val();
                        dsKiemPhieuDiv.innerHTML += `<p>${stt}. √îng/B√†: ${data.hoTen || ''} - ${data.chucVu || ''}</p>`;
                        stt++;
                    });
                } else {
                     dsKiemPhieuDiv.innerHTML = '<p>Kh√¥ng c√≥ d·ªØ li·ªáu.</p>';
                }

                // 4. Process list of "chungKien" from thongtin.html
                const dsChungKienDiv = document.getElementById('danhSachChungKienBb');
                dsChungKienDiv.innerHTML = '';
                if (dsChungKienSnap.exists()) {
                    let stt = 1;
                    dsChungKienSnap.forEach(child => {
                        const data = child.val();
                        dsChungKienDiv.innerHTML += `<p>${stt}. √îng/B√†: ${data.hoTen || ''} - N∆°i ·ªü hi·ªán nay: ${data.diaChi || ''}</p>`;
                        stt++;
                    });
                } else {
                    dsChungKienDiv.innerHTML = '<p>Kh√¥ng c√≥ d·ªØ li·ªáu.</p>';
                }
                
                // 5. Process candidate results from kiemphieu.html
                const ketQuaUngVienContainer = document.getElementById('ketQuaUngVienContainer');
                ketQuaUngVienContainer.innerHTML = '';
                const ungCuData = ungCuSnap.exists() ? ungCuSnap.val() : {};
                const candidateResultsData = candidateResultsSnap.exists() ? candidateResultsSnap.val() : {};
                
                let resultsHtml = '';
                Object.keys(ungCuData).forEach(key => {
                    const hoTen = ungCuData[key].hoTen;
                    const result = candidateResultsData[key] || { soPhieu: 0, phanTram: '0%' };
                    resultsHtml += `<p>√îng/B√† ${hoTen} ƒë∆∞·ª£c ${result.soPhieu} phi·∫øu, ƒë·∫°t t·ª∑ l·ªá ${result.phanTram}</p>`;
                });
                ketQuaUngVienContainer.innerHTML = resultsHtml || '<p>Ch∆∞a c√≥ k·∫øt qu·∫£ ki·ªÉm phi·∫øu cho ·ª©ng vi√™n.</p>';

            } catch (error) {
                console.error('Error loading bien ban data:', error);
                alert('L·ªói t·∫£i d·ªØ li·ªáu bi√™n b·∫£n: ' + error.message);
            }
        }
        
        // NEW FUNCTION: Export to Word
        function exportToWord() {
            const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' " +
                "xmlns:w='urn:schemas-microsoft-com:office:word' " +
                "xmlns='http://www.w3.org/TR/REC-html40'>" +
                "<head><meta charset='utf-8'><title>Export HTML to Word Document</title></head><body>";
            
            const footer = "</body></html>";
            
            // Clone the content to avoid modifying the displayed version
            const contentElement = document.getElementById('bienBanContent').cloneNode(true);
            
            // Optional: You can add specific styles for Word here if needed
            // For example, force tables to have borders
            const tables = contentElement.getElementsByTagName('table');
            for(let i=0; i<tables.length; i++){
                tables[i].style.border = '1px solid black';
                tables[i].style.borderCollapse = 'collapse';
                const cells = tables[i].getElementsByTagName('td');
                 for(let j=0; j<cells.length; j++){
                    cells[j].style.border = '1px solid black';
                 }
            }

            const sourceHTML = header + contentElement.innerHTML + footer;
            
            const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
            const fileDownload = document.createElement("a");
            document.body.appendChild(fileDownload);
            fileDownload.href = source;
            const khuVucSo = document.getElementById('khuVucBoPhieuBb').textContent || 'X';
            fileDownload.download = `bien_ban_khu_vuc_so_${khuVucSo}.doc`;
            fileDownload.click();
            document.body.removeChild(fileDownload);
        }

        document.getElementById('btnInBienBan').addEventListener('click', () => window.print());
        document.getElementById('btnTaiXuongWord').addEventListener('click', exportToWord);

        function initApp() {
            auth.onAuthStateChanged(async (user) => {
                const loadingElement = document.getElementById('loading');
                const mainContentElement = document.getElementById('mainContent');
                
                if (user) {
                    currentUser = user;
                    document.getElementById('userName').textContent = user.email || 'Qu·∫£n tr·ªã vi√™n';
                    await loadBienBanData();
                    loadingElement.style.display = 'none';
                    mainContentElement.style.display = 'block';
                } else {
                    loadingElement.innerHTML = 'Ch∆∞a ƒëƒÉng nh·∫≠p, ƒëang chuy·ªÉn h∆∞·ªõng...';
                    setTimeout(() => { window.location.href = 'index.html'; }, 2000);
                }
            });
        }
        
        document.getElementById('logout').addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
                auth.signOut().then(() => { window.location.href = 'index.html'; });
            }
        });

        window.addEventListener('load', initApp);
    </script>
</body>
</html>
