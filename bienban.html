<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bi√™n b·∫£n k·∫øt qu·∫£ ki·ªÉm phi·∫øu</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Times New Roman', serif; }
        body { background-color: #f5f7fa; color: #000; font-size: 14px; line-height: 1.6; }
        .container { display: flex; min-height: 100vh; }
        .sidebar { width: 220px; background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; padding: 15px 0; box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1); }
        .logo { text-align: center; padding: 15px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 15px; }
        .logo h1 { font-size: 18px; font-weight: 600; }
        .nav-links { list-style: none; padding: 0 10px; }
        .nav-links li { margin-bottom: 8px; }
        .nav-links a { display: flex; align-items: center; padding: 10px 12px; color: white; text-decoration: none; border-radius: 6px; transition: all 0.3s ease; font-size: 13px; }
        .nav-links a:hover, .nav-links a.active { background-color: rgba(255, 255, 255, 0.1); }
        .main-content { flex: 1; padding: 20px; min-width: 0; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .header h2 { font-size: 20px; color: #2a5298; }
        .user-info { display: flex; align-items: center; background: white; padding: 8px 16px; border-radius: 25px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); font-size: 13px; }
        .user-info img { width: 32px; height: 32px; border-radius: 50%; margin-right: 8px; }

        .bien-ban-wrapper { background: white; padding: 40px; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1); max-width: 850px; margin: 20px auto; }
        .bb-header-top { display: flex; justify-content: space-between; font-weight: bold; }
        .bb-title { text-align: center; margin: 20px 0; }
        .bb-title h2 { font-size: 16px; font-weight: bold; text-transform: uppercase; }
        .bb-title p { font-size: 14px; font-weight: bold; }
        .bb-body p { margin-bottom: 10px; }
        .bb-list { padding-left: 20px; }
        .bb-results-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .bb-results-table td { padding: 5px; }
        .bb-signature { display: grid; grid-template-columns: 1fr 1fr; margin-top: 50px; text-align: center; gap: 20px; }
        .bb-signature p { font-weight: bold; }
        .bb-signature .sig-role { font-style: italic; font-weight: normal; }
        .btn { padding: 8px 16px; background: #2a5298; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: background 0.3s ease; margin-right: 10px; margin-bottom: 10px; }
        .btn:hover { background: #1e3c72; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .loading { text-align: center; padding: 20px; color: #666; font-size: 13px; }
        .action-buttons { display: flex; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .placeholder { color: #888; }
        @media print {
            body { background: white; font-size: 12pt; }
            .sidebar, .header, .action-buttons { display: none !important; }
            .main-content { padding: 0; }
            .bien-ban-wrapper { box-shadow: none; padding: 0; margin: 0; max-width: none; border: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo"><h1>H·ªÜ TH·ªêNG B·∫¶U C·ª¨</h1></div>
            <ul class="nav-links">
                <li><a href="thongtin.html"><i>‚ÑπÔ∏è</i> Th√¥ng tin</a></li>
                <li><a href="kiemphieu.html"><i>‚úÖ</i> Ki·ªÉm phi·∫øu</a></li>
                <li><a href="#"><i>üìà</i> T·ªïng h·ª£p</a></li>
                <li><a href="bienban.html" class="active"><i>üìù</i> Bi√™n b·∫£n</a></li>
                <li class="logout"><a href="#" id="logout"><i>üö™</i> ƒêƒÉng xu·∫•t</a></li>
            </ul>
        </div>

        <div class="main-content">
            <div class="header">
                <h2>Bi√™n b·∫£n k·∫øt qu·∫£ ki·ªÉm phi·∫øu</h2>
                <div class="user-info">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=2a5298&color=fff" alt="User">
                    <span id="userName">Qu·∫£n tr·ªã vi√™n</span>
                </div>
            </div>

            <div id="loading" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>

            <div id="mainContent" style="display: none;">
                <div class="action-buttons">
                    <button id="btnInBienBan" class="btn">In bi√™n b·∫£n</button>
                    <button id="btnTaiXuongWord" class="btn btn-success">T·∫£i xu·ªëng Word (.doc)</button>
                </div>

                <div id="bienBanContent" class="bien-ban-wrapper">
                    <div class="bb-header-top">
                        <p>T·ªânh/Th√†nh ph·ªë: <span id="tinhThanhBb">...</span><br>X√£/Ph∆∞·ªùng/Th·ªã tr·∫•n: <span id="phuongXaBb">...</span></p>
                        <p style="text-align: center;">C·ªòNG H√íA X√É H·ªòI CH·ª¶ NGHƒ®A VI·ªÜT NAM<br>ƒê·ªôc l·∫≠p - T·ª± do - H·∫°nh ph√∫c</p>
                    </div>

                    <div class="bb-title">
                        <h2>Bi√™n b·∫£n k·∫øt qu·∫£ ki·ªÉm phi·∫øu</h2>
                        <p>B·∫¶U C·ª¨ ƒê·∫†I BI·ªÇU H·ªòI ƒê·ªíNG NH√ÇN D√ÇN <span id="capBauCuBb">...</span><br>KH√ìA <span id="khoaBb">...</span> NHI·ªÜM K·ª≤ <span id="nhiemKyBb">...</span></p>
                        <h3>C·ª¶A T·ªî B·∫¶U C·ª¨</h3>
                    </div>

                    <div class="bb-body">
                        <p><strong>- S·ªë phi·∫øu b·∫ßu cho m·ªói ng∆∞·ªùi ·ª©ng c·ª≠:</strong></p>
                        <div id="ketQuaUngVienContainer" class="bb-list">
                            <p class="placeholder">ƒêang t·∫£i k·∫øt qu·∫£...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyAt-OooTscmthbJXNcvy80RgPDA9T46-0w", 
            authDomain: "kiemphieu-45823.firebaseapp.com", 
            databaseURL: "https://kiemphieu-45823-default-rtdb.asia-southeast1.firebasedatabase.app", 
            projectId: "kiemphieu-45823", 
            storageBucket: "kiemphieu-45823.firebasestorage.app", 
            messagingSenderId: "908329514571", 
            appId: "1:908329514571:web:16b43df5b795e4de06bfce" 
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        let currentUser = null;

        function getUserPath(path = '') {
            if (!currentUser || !currentUser.uid) throw new Error('User not authenticated');
            return `users/${currentUser.uid}${path ? '/' + path : ''}`;
        }

        async function loadBienBanData() {
            const [ungCuSnap, kiemPhieuDataSnap] = await Promise.all([
                db.ref(getUserPath('ungCu')).once('value'),
                db.ref(getUserPath('kiemPhieuData')).once('value')
            ]);

            // === T√çNH T·ªîNG PHI·∫æU CHO T·ª™NG ·ª®NG C·ª¨ VI√äN ===
            const ketQuaUngVienContainer = document.getElementById('ketQuaUngVienContainer');
            ketQuaUngVienContainer.innerHTML = '';

            const ungCuData = ungCuSnap.exists() ? ungCuSnap.val() : {};
            let phieuDetails = [];
            let soPhieuHopLe = 0;

            // --- L·∫•y danh s√°ch phi·∫øu ƒë√£ ki·ªÉm t·ª´ Firebase ---
            const phieuSnap = await db.ref(getUserPath('phieuDetails')).once('value');
            if (phieuSnap.exists()) {
                const raw = phieuSnap.val();
                phieuDetails = Array.isArray(raw) ? raw.filter(p => p !== null) : Object.values(raw);

                // Ch·ªâ t√≠nh phi·∫øu h·ª£p l·ªá
                soPhieuHopLe = phieuDetails.filter(p => p.trangThai === 'H·ª£p l·ªá').length;
            }

            // N·∫øu ch∆∞a c√≥ d·ªØ li·ªáu phi·∫øu h·ª£p l·ªá th√¨ l·∫•y theo t·ªïng s·ªë phi·∫øu thu v√†o
            if (soPhieuHopLe === 0 && kiemPhieuDataSnap.exists()) {
                const data = kiemPhieuDataSnap.val();
                soPhieuHopLe = parseInt(data.soPhieuThuVao) || 0;
            }

            // --- Kh·ªüi t·∫°o t·ªïng phi·∫øu c·ªßa t·ª´ng ·ª©ng vi√™n ---
            const tongPhieuTheoUngVien = {};
            Object.keys(ungCuData).forEach(key => {
                tongPhieuTheoUngVien[key] = 0;
            });

            // --- C·ªông d·ªìn t·ªïng phi·∫øu cho t·ª´ng ·ª©ng vi√™n ---
            phieuDetails.forEach(phieu => {
                if (phieu.trangThai === 'H·ª£p l·ªá') {
                    Object.keys(ungCuData).forEach(key => {
                        if (!phieu.selectedIds.includes(key)) {
                            tongPhieuTheoUngVien[key]++;
                        }
                    });
                }
            });

            // --- Hi·ªÉn th·ªã k·∫øt qu·∫£ ---
            let resultsHtml = '';
            Object.keys(ungCuData).forEach(key => {
                const hoTen = ungCuData[key].hoTen || '(Kh√¥ng t√™n)';
                const tongPhieu = tongPhieuTheoUngVien[key] || 0;
                resultsHtml += `<p>√îng/B√† ${hoTen} ƒë∆∞·ª£c ${tongPhieu} phi·∫øu / ${soPhieuHopLe} phi·∫øu h·ª£p l·ªá</p>`;
            });

            ketQuaUngVienContainer.innerHTML = resultsHtml || '<p class=\"placeholder\">Ch∆∞a c√≥ k·∫øt qu·∫£.</p>';
        }

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                await loadBienBanData();
            } else {
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>
